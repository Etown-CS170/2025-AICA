<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 p-4 transition-colors duration-300">
  <div class="max-w-6xl mx-auto">
    
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-6 transition-colors duration-300">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="aica_complex-nobg.png" alt="AICA Logo" class="w-12 h-12">
          <div>
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white">AICA</h1>
            <p class="text-gray-600 dark:text-gray-400 text-sm">AI Communication Assistant</p>
          </div>
        </div>
        
        <!-- Auth & Theme Section -->
        <div class="flex items-center gap-3">
          <!-- Settings Button (only show when authenticated) -->
          <button 
            *ngIf="(isAuthenticated$ | async)"
            (click)="toggleSettingsModal()"
            class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
            title="Settings">
            <lucide-icon [img]="Settings" class="w-5 h-5 text-gray-700 dark:text-gray-300"></lucide-icon>
          </button>

          <!-- Theme Toggle Button -->
          <button 
            (click)="toggleTheme()"
            class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
            [title]="(theme$ | async) === 'light' ? 'Switch to dark mode' : 'Switch to light mode'">
            <lucide-icon 
              *ngIf="(theme$ | async) === 'light'" 
              [img]="Moon" 
              class="w-5 h-5 text-gray-700 dark:text-gray-300"></lucide-icon>
            <lucide-icon 
              *ngIf="(theme$ | async) === 'dark'" 
              [img]="Sun" 
              class="w-5 h-5 text-yellow-400"></lucide-icon>
          </button>

          <!-- Loading State -->
          <div *ngIf="(isAuthenticated$ | async) === null" class="text-gray-500 dark:text-gray-400">
            Loading...
          </div>
          
          <!-- Logged Out State -->
          <button 
            *ngIf="(isAuthenticated$ | async) === false"
            (click)="login()"
            class="flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <lucide-icon [img]="LogIn" class="w-5 h-5"></lucide-icon>
            Sign In
          </button>
          
          <!-- Logged In State -->
          <div *ngIf="(isAuthenticated$ | async) === true" class="flex items-center gap-4">
            <div class="flex items-center gap-3">
              <img 
                *ngIf="(user$ | async)?.picture" 
                [src]="(user$ | async)?.picture" 
                [alt]="(user$ | async)?.name"
                class="w-10 h-10 rounded-full border-2 border-blue-500">
              <div class="text-right">
                <p class="text-sm font-semibold text-gray-800 dark:text-white">{{ (user$ | async)?.name }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">{{ (user$ | async)?.email }}</p>
              </div>
            </div>
            <button 
              (click)="logout()"
              class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
              <lucide-icon [img]="LogOut" class="w-5 h-5"></lucide-icon>
              Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Auth Required Message -->
    <div *ngIf="(isAuthenticated$ | async) === false" 
        class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 text-blue-700 dark:text-blue-300 px-4 py-3 rounded-lg mb-6 transition-colors duration-300">
      <p class="font-medium">üîê Please sign in to generate emails</p>
      <p class="text-sm mt-1">Sign in with Google, Microsoft, GitHub, Apple, or email/password</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg mb-6 transition-colors duration-300">
      <p class="font-medium">{{ errorMessage }}</p>
    </div>

    <!-- Copy Success Message -->
    <div *ngIf="showCopySuccess" class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 px-4 py-3 rounded-lg mb-6 flex items-center gap-2 transition-colors duration-300">
      <lucide-icon [img]="Copy" class="w-5 h-5"></lucide-icon>
      <p class="font-medium">Copied to clipboard!</p>
    </div>

    <!-- Save Success Message -->
    <div *ngIf="showSaveSuccess" class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 text-green-700 dark:text-green-300 px-4 py-3 rounded-lg mb-6 flex items-center gap-2 transition-colors duration-300">
      <lucide-icon [img]="Save" class="w-5 h-5"></lucide-icon>
      <p class="font-medium">Saved to database!</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- Controls Panel -->
      <div class="lg:col-span-1 space-y-4">
        
        <!-- Tone Selection -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-5 transition-colors duration-300">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2">
              <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
              Tone
            </h3>
            <button
              (click)="toggleCustomTone()"
              [class]="isCustomTone ? 'text-orange-600 dark:text-orange-400' : 'text-gray-400 dark:text-gray-500'"
              class="hover:text-orange-600 dark:hover:text-orange-400 transition-colors"
              title="Custom tone">
              <lucide-icon [img]="Edit3" class="w-4 h-4"></lucide-icon>
            </button>
          </div>
          
          <!-- Custom Tone Input -->
          <div *ngIf="isCustomTone" class="mb-3">
            <input
              type="text"
              [(ngModel)]="customTone"
              placeholder="e.g., Casual, Urgent, Apologetic..."
              class="w-full px-3 py-2 border border-orange-300 dark:border-orange-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 transition-colors duration-300"
            />
            <button
              *ngIf="customTone.trim() && (isAuthenticated$ | async)"
              (click)="saveCustomTone()"
              class="mt-2 w-full px-3 py-2 text-sm bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
              <lucide-icon [img]="Save" class="w-4 h-4 inline mr-2"></lucide-icon>
              Save Tone
            </button>
          </div>
          
          <!-- Minimized View - Show only selected tone -->
          <div *ngIf="!isCustomTone && shouldMinimizeTones()" class="space-y-2">
            <button
              *ngFor="let tone of tones"
              [hidden]="tone.id !== selectedTone"
              (click)="toggleTone(tone.id)"
              class="w-full px-4 py-3 rounded-lg text-sm font-medium transition-all bg-orange-500 text-white shadow-md">
              {{ tone.label }}
            </button>
          </div>
          
          <!-- Expanded View - Show all tones -->
          <div *ngIf="!isCustomTone && !shouldMinimizeTones()" class="space-y-2">
            <button
              *ngFor="let tone of tones"
              (click)="toggleTone(tone.id)"
              [class]="selectedTone === tone.id 
                ? 'bg-orange-500 text-white shadow-md' 
                : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'"
              class="w-full px-4 py-3 rounded-lg text-sm font-medium transition-all">
              {{ tone.label }}
            </button>
          </div>
        </div>

        <!-- Audience Selection -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-5 transition-colors duration-300">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2">
              <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
              Audience
            </h3>
            <button
              (click)="toggleCustomAudience()"
              [class]="isCustomAudience ? 'text-purple-600 dark:text-purple-400' : 'text-gray-400 dark:text-gray-500'"
              class="hover:text-purple-600 dark:hover:text-purple-400 transition-colors"
              title="Custom audience">
              <lucide-icon [img]="Edit3" class="w-4 h-4"></lucide-icon>
            </button>
          </div>
          
          <!-- Custom Audience Input -->
          <div *ngIf="isCustomAudience" class="mb-3">
            <textarea
              [(ngModel)]="customAudience"
              placeholder="e.g., CEO, Client, Team Member"
              rows="2"
              class="w-full px-3 py-2 border border-purple-300 dark:border-purple-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm resize-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 transition-colors duration-300"
            ></textarea>
            <button
              *ngIf="customAudience.trim() && (isAuthenticated$ | async)"
              (click)="saveCustomAudience()"
              class="mt-2 w-full px-3 py-2 text-sm bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
              <lucide-icon [img]="Save" class="w-4 h-4 inline mr-2"></lucide-icon>
              Save Audience
            </button>
          </div>
          
          <!-- Minimized View - Show only selected audience -->
          <div *ngIf="!isCustomAudience && shouldMinimizeAudiences()" class="space-y-2">
            <button
              *ngFor="let audience of audiences"
              [hidden]="audience.id !== selectedAudience"
              (click)="toggleAudience(audience.id)"
              class="w-full px-4 py-3 rounded-lg text-sm font-medium transition-all bg-purple-500 text-white shadow-md">
              {{ audience.label }}
            </button>
          </div>
          
          <!-- Expanded View - Show all audiences -->
          <div *ngIf="!isCustomAudience && !shouldMinimizeAudiences()" class="space-y-2">
            <button
              *ngFor="let audience of audiences"
              (click)="toggleAudience(audience.id)"
              [class]="selectedAudience === audience.id 
                ? 'bg-purple-500 text-white shadow-md' 
                : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'"
              class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all">
              <span class="font-medium">{{ audience.label }}</span>
            </button>
          </div>
        </div>

        <!-- Templates -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-5 transition-colors duration-300">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2">
              <div class="w-2 h-2 bg-green-500 rounded-full"></div>
              Quick Templates
            </h3>
            <button
              (click)="toggleCustomTemplate()"
              [class]="isCustomTemplate ? 'text-green-600 dark:text-green-400' : 'text-gray-400 dark:text-gray-500'"
              class="hover:text-green-600 dark:hover:text-green-400 transition-colors"
              title="Custom template">
              <lucide-icon [img]="Edit3" class="w-4 h-4"></lucide-icon>
            </button>
          </div>

          <!-- Custom Template Input -->
          <div *ngIf="isCustomTemplate" class="mb-3">
            <input
              type="text"
              [(ngModel)]="customTemplateName"
              placeholder="Template name..."
              class="w-full px-3 py-2 mb-2 border border-green-300 dark:border-green-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 transition-colors duration-300"
            />
            <textarea
              [(ngModel)]="customTemplate"
              (ngModelChange)="onCustomTemplateChange()"
              (keypress)="onKeyPress($event)"
              placeholder="e.g., Write a project update email"
              rows="3"
              class="w-full px-3 py-2 border border-green-300 dark:border-green-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm resize-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 transition-colors duration-300"
            ></textarea>
            <button
              *ngIf="customTemplate.trim() && customTemplateName.trim() && (isAuthenticated$ | async)"
              (click)="saveCustomTemplate()"
              class="mt-2 w-full px-3 py-2 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
              <lucide-icon [img]="Save" class="w-4 h-4 inline mr-2"></lucide-icon>
              Save Template
            </button>
          </div>

          <!-- Minimized View - Show only selected template -->
          <div *ngIf="!isCustomTemplate && shouldMinimizeTemplates()" class="space-y-2">
            <button
              *ngFor="let template of templates"
              [hidden]="template.id !== selectedTemplate"
              (click)="selectTemplate(template)"
              class="w-full text-left px-4 py-2 rounded-lg text-sm transition-colors bg-green-500 text-white shadow-md">
              {{ template.name }}
            </button>
          </div>

          <!-- Expanded View - Show all templates -->
          <div *ngIf="!isCustomTemplate && !shouldMinimizeTemplates()" class="space-y-2">
            <button
              *ngFor="let template of templates"
              (click)="selectTemplate(template)"
              [class]="selectedTemplate === template.id 
                ? 'bg-green-500 text-white shadow-md' 
                : 'bg-gray-100 dark:bg-gray-700 hover:bg-green-100 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300'"
              class="w-full text-left px-4 py-2 rounded-lg text-sm transition-colors">
              {{ template.name }}
            </button>
          </div>
        </div>

        <!-- Email Signature Selection Panel -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-5 transition-colors duration-300">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2">
              <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
              Email Signature
            </h3>
            <button
              (click)="toggleCustomSignature()"
              [class]="isCustomSignature ? 'text-yellow-600 dark:text-yellow-400' : 'text-gray-400 dark:text-gray-500'"
              class="hover:text-yellow-600 dark:hover:text-yellow-400 transition-colors"
              title="Custom signature">
              <lucide-icon [img]="Edit3" class="w-4 h-4"></lucide-icon>
            </button>
          </div>
          
          <!-- Custom Signature Input -->
          <div *ngIf="isCustomSignature" class="mb-3">
            <input
              type="text"
              [(ngModel)]="customSignatureName"
              placeholder="Signature name (e.g., Professional, Work)"
              class="w-full px-3 py-2 mb-2 border border-yellow-300 dark:border-yellow-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 transition-colors duration-300"
            />
            <textarea
              [(ngModel)]="customSignatureContent"
              placeholder="Best regards,&#10;Your Name&#10;Your Title&#10;Your Company"
              rows="4"
              class="w-full px-3 py-2 border border-yellow-300 dark:border-yellow-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 text-sm resize-none font-mono bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 transition-colors duration-300"
            ></textarea>
            <button
              *ngIf="customSignatureName.trim() && customSignatureContent.trim() && (isAuthenticated$ | async)"
              (click)="saveCustomSignature()"
              class="mt-2 w-full px-3 py-2 text-sm bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
              <lucide-icon [img]="Save" class="w-4 h-4 inline mr-2"></lucide-icon>
              Save Signature
            </button>
          </div>
          
          <!-- Minimized View - Show only selected signature or "No Signature" -->
          <div *ngIf="!isCustomSignature && shouldMinimizeSignatures()" class="space-y-2">
            <button
              *ngFor="let signature of signatures"
              [hidden]="signature.id !== selectedSignatureId"
              (click)="toggleSignature(signature.id)"
              class="w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-all bg-yellow-500 text-white shadow-md">
              <div class="flex items-center justify-between">
                <span>{{ signature.name }}</span>
                <span *ngIf="signature.isDefault" class="text-xs opacity-75">Default</span>
              </div>
            </button>
          </div>
          
          <!-- Expanded View - Show all signatures -->
          <div *ngIf="!isCustomSignature && !shouldMinimizeSignatures()" class="space-y-2">
            <button
              *ngFor="let signature of signatures"
              (click)="toggleSignature(signature.id)"
              [class]="selectedSignatureId === signature.id 
                ? 'bg-yellow-500 text-white shadow-md' 
                : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'"
              class="w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-all">
              <div class="flex items-center justify-between">
                <span>{{ signature.name }}</span>
                <span *ngIf="signature.isDefault" class="text-xs opacity-75">Default</span>
              </div>
            </button>
            <button
              (click)="selectedSignatureId = ''"
              [class]="selectedSignatureId === '' 
                ? 'bg-yellow-500 text-white shadow-md' 
                : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'"
              class="w-full text-left px-4 py-2 rounded-lg text-sm transition-all">
              No Signature
            </button>
          </div>
        </div>

      </div>

      <!-- Chat Interface -->
      <div class="lg:col-span-2">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden flex flex-col h-[600px] transition-colors duration-300">
          
          <!-- Messages Area -->
          <div #messagesContainer class="flex-1 overflow-y-auto p-6 space-y-4">
            
            <!-- Empty State -->
            <div *ngIf="messages.length === 0" class="text-center text-gray-400 dark:text-gray-500 mt-20">
              <lucide-icon [img]="Mail" class="w-16 h-16 mx-auto mb-4 opacity-50"></lucide-icon>
              <p class="text-lg">Start composing your email</p>
              <p class="text-sm mt-2">Describe what you need or select a template</p>
            </div>

            <!-- Messages -->
            <div *ngFor="let message of messages" 
                 [class]="message.type === 'user' ? 'flex justify-end' : 'flex justify-start'">
              <div [class]="message.type === 'user' 
                   ? 'bg-blue-600 text-white' 
                   : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'"
                   class="max-w-[85%] rounded-2xl p-4 transition-colors duration-300">
                
                <!-- User message metadata -->
                <div *ngIf="message.type === 'user'" class="flex flex-wrap gap-2 mb-2">
                  <div *ngIf="message.tone" class="flex items-center gap-1.5 px-2.5 py-1 bg-orange-500 rounded-md text-xs">
                    <div class="w-1.5 h-1.5 bg-white rounded-full"></div>
                    <span class="text-white font-medium">{{ message.tone }}</span>
                  </div>
                  <div *ngIf="message.audience" class="flex items-center gap-1.5 px-2.5 py-1 bg-purple-500 rounded-md text-xs">
                    <div class="w-1.5 h-1.5 bg-white rounded-full"></div>
                    <span class="text-white font-medium">{{ message.audience }}</span>
                  </div>
                  <div *ngIf="message.signature" class="flex items-center gap-1.5 px-2.5 py-1 bg-yellow-500 rounded-md text-xs">
                    <div class="w-1.5 h-1.5 bg-white rounded-full"></div>
                    <span class="text-white font-medium">{{ message.signature }}</span>
                  </div>
                </div>

                <!-- Message content -->
                <div class="whitespace-pre-wrap font-mono text-sm">{{ message.content }}</div>

                <!-- Action Buttons for AI messages -->
                <div *ngIf="message.type === 'ai'" class="flex gap-2 mt-3">
                  <!-- Copy button -->
                  <button 
                    (click)="copyToClipboard(message.content)"
                    class="flex items-center gap-2 px-3 py-2 text-sm border border-blue-300 dark:border-blue-600 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors">
                    <lucide-icon [img]="Copy" class="w-4 h-4"></lucide-icon>
                    Copy
                  </button>

                  <!-- Save to Library button -->
                  <button 
                    *ngIf="(isAuthenticated$ | async)"
                    (click)="saveEmailToLibrary(message.content)"
                    class="flex items-center gap-2 px-3 py-2 text-sm border border-green-300 dark:border-green-600 text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-colors">
                    <lucide-icon [img]="Save" class="w-4 h-4"></lucide-icon>
                    Save
                  </button>
                </div>
              </div>
            </div>

            <!-- Loading indicator -->
            <div *ngIf="isGenerating" class="flex justify-start">
              <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl p-4 transition-colors duration-300">
                <div class="flex gap-2">
                  <div class="w-2 h-2 bg-gray-400 dark:bg-gray-500 rounded-full animate-bounce"></div>
                  <div class="w-2 h-2 bg-gray-400 dark:bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                  <div class="w-2 h-2 bg-gray-400 dark:bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
              </div>
            </div>

          </div>

          <!-- Input Area -->
          <div class="border-t border-gray-200 dark:border-gray-700 p-4 transition-colors duration-300">
            <!-- Current Selection Tags -->
            <div class="flex gap-2 mb-3">
              <div *ngIf="getCurrentTone()" 
                  class="flex items-center gap-2 px-3 py-1.5 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-lg text-xs font-medium">
                <div class="w-1.5 h-1.5 bg-orange-500 rounded-full"></div>
                <span>{{ getCurrentTone() }}</span>
              </div>
              <div *ngIf="getCurrentAudience()" 
                  class="flex items-center gap-2 px-3 py-1.5 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg text-xs font-medium">
                <div class="w-1.5 h-1.5 bg-purple-500 rounded-full"></div>
                <span>{{ getCurrentAudience() }}</span>
              </div>
              <div *ngIf="getCurrentSignature()" 
                  class="flex items-center gap-2 px-3 py-1.5 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-lg text-xs font-medium">
                <div class="w-1.5 h-1.5 bg-yellow-500 rounded-full"></div>
                <span>{{ getCurrentSignature() }}</span>
              </div>
            </div>

            <div class="flex gap-3">
              <input
                type="text"
                [(ngModel)]="inputText"
                (keypress)="onKeyPress($event)"
                [disabled]="isGenerating"
                [placeholder]="isCustomTemplate ? 'Type in custom template above...' : 'Describe your email need...'"
                class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100 dark:disabled:bg-gray-700 disabled:cursor-not-allowed bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 transition-colors duration-300" />
              
              <button
                (click)="onSend()"
                [disabled]="!canSend() || !(isAuthenticated$ | async)"
                class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 disabled:bg-gray-300 dark:disabled:bg-gray-700 disabled:cursor-not-allowed transition-colors flex items-center gap-2">
                <lucide-icon [img]="Send" class="w-5 h-5"></lucide-icon>
              </button>

              <button
                *ngIf="messages.length > 0"
                (click)="reset()"
                class="px-4 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors"
                title="Clear conversation">
                <lucide-icon [img]="RotateCcw" class="w-5 h-5"></lucide-icon>
              </button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- Settings Modal -->
  <div *ngIf="showSettingsModal" 
       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
       (click)="closeSettingsModal($event)">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden"
         (click)="$event.stopPropagation()">
      
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center gap-3">
          <lucide-icon [img]="Settings" class="w-6 h-6 text-blue-600 dark:text-blue-400"></lucide-icon>
          <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Preferences</h2>
        </div>
        <button 
          (click)="toggleSettingsModal()"
          class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
          <lucide-icon [img]="X" class="w-6 h-6 text-gray-600 dark:text-gray-400"></lucide-icon>
        </button>
      </div>

      <!-- Modal Content -->
      <div class="overflow-y-auto max-h-[calc(90vh-200px)] p-6">
        
        <!-- Saved Tones Section -->
        <div class="mb-8">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2">
              <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
              My Tones
            </h3>
            <button
              *ngIf="tones.length < 8"
              (click)="toggleAddTone()"
              class="flex items-center gap-2 px-3 py-2 text-sm bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
              <lucide-icon [img]="Plus" class="w-4 h-4"></lucide-icon>
              Add Tone
            </button>
          </div>

          <!-- Add Tone Form -->
          <div *ngIf="showAddTone" class="mb-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Label *</label>
              <input
                type="text"
                [(ngModel)]="newToneLabel"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white"
                placeholder="e.g., Enthusiastic"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
              <input
                type="text"
                [(ngModel)]="newToneDescription"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white"
                placeholder="e.g., Positive and energetic"
              />
            </div>
            <div class="flex gap-2 justify-end">
              <button 
                (click)="cancelAddTone()"
                class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                Cancel
              </button>
              <button 
                (click)="saveNewTone()"
                [disabled]="!canSaveNewTone()"
                class="px-4 py-2 text-sm text-white bg-orange-500 hover:bg-orange-600 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-lg transition-colors flex items-center gap-2">
                <lucide-icon [img]="Save" class="w-4 h-4"></lucide-icon>
                Save Tone
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div *ngFor="let tone of tones" 
                 class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
              
              <!-- View Mode -->
              <div *ngIf="editingToneId !== tone.id" class="flex items-center justify-between w-full">
                <div class="flex items-center gap-3">
                  <div [class]="tone.color" class="w-3 h-3 rounded-full"></div>
                  <div>
                    <p class="font-medium text-gray-800 dark:text-white">{{ tone.label }}</p>
                    <p *ngIf="tone.description" class="text-xs text-gray-500 dark:text-gray-400">{{ tone.description }}</p>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button 
                    (click)="startEditingTone(tone)"
                    class="p-2 text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-colors"
                    title="Edit">
                    <lucide-icon [img]="Edit3" class="w-4 h-4"></lucide-icon>
                  </button>
                  <button 
                    *ngIf="tones.length > 4"
                    (click)="deleteToneFromSettings(tone.id)"
                    class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                    title="Delete">
                    <lucide-icon [img]="Trash2" class="w-4 h-4"></lucide-icon>
                  </button>
                </div>
              </div>

              <!-- Edit Mode -->
              <div *ngIf="editingToneId === tone.id" class="w-full space-y-2">
                <input
                  type="text"
                  [(ngModel)]="editingToneLabel"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white text-sm"
                  placeholder="Label"
                />
                <input
                  type="text"
                  [(ngModel)]="editingToneDescription"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white text-sm"
                  placeholder="Description"
                />
                <div class="flex gap-2 justify-end">
                  <button 
                    (click)="cancelEditingTone()"
                    class="px-3 py-1 text-xs text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                    Cancel
                  </button>
                  <button 
                    (click)="saveEditedTone(tone.id)"
                    class="px-3 py-1 text-xs text-white bg-orange-500 hover:bg-orange-600 rounded-lg transition-colors">
                    Save
                  </button>
                </div>
              </div>
            </div>
          </div>
          <p *ngIf="tones.length >= 8" class="text-sm text-orange-600 dark:text-orange-400 mt-2">
            Maximum 8 tones reached. Delete one to add more.
          </p>
        </div>

        <!-- Saved Audiences Section -->
        <div class="mb-8">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2">
              <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
              My Audiences
            </h3>
            <button
              *ngIf="audiences.length < 8"
              (click)="toggleAddAudience()"
              class="flex items-center gap-2 px-3 py-2 text-sm bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
              <lucide-icon [img]="Plus" class="w-4 h-4"></lucide-icon>
              Add Audience
            </button>
          </div>

          <!-- Add Audience Form -->
          <div *ngIf="showAddAudience" class="mb-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Label *</label>
              <input
                type="text"
                [(ngModel)]="newAudienceLabel"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white"
                placeholder="e.g., Client"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
              <input
                type="text"
                [(ngModel)]="newAudienceDescription"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white"
                placeholder="e.g., Business client or customer"
              />
            </div>
            <div class="flex gap-2 justify-end">
              <button 
                (click)="cancelAddAudience()"
                class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                Cancel
              </button>
              <button 
                (click)="saveNewAudience()"
                [disabled]="!canSaveNewAudience()"
                class="px-4 py-2 text-sm text-white bg-purple-500 hover:bg-purple-600 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-lg transition-colors flex items-center gap-2">
                <lucide-icon [img]="Save" class="w-4 h-4"></lucide-icon>
                Save Audience
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div *ngFor="let audience of audiences" 
                 class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
              
              <!-- View Mode -->
              <div *ngIf="editingAudienceId !== audience.id" class="flex items-center justify-between w-full">
                <div class="flex items-center gap-3">
                  <div>
                    <p class="font-medium text-gray-800 dark:text-white">{{ audience.label }}</p>
                    <p *ngIf="audience.description" class="text-xs text-gray-500 dark:text-gray-400">{{ audience.description }}</p>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button 
                    (click)="startEditingAudience(audience)"
                    class="p-2 text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-colors"
                    title="Edit">
                    <lucide-icon [img]="Edit3" class="w-4 h-4"></lucide-icon>
                  </button>
                  <button 
                    (click)="deleteAudienceFromSettings(audience.id)"
                    class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                    title="Delete">
                    <lucide-icon [img]="Trash2" class="w-4 h-4"></lucide-icon>
                  </button>
                </div>
              </div>

              <!-- Edit Mode -->
              <div *ngIf="editingAudienceId === audience.id" class="w-full space-y-2">
                <input
                  type="text"
                  [(ngModel)]="editingAudienceLabel"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white text-sm"
                  placeholder="Label"
                />
                <input
                  type="text"
                  [(ngModel)]="editingAudienceDescription"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white text-sm"
                  placeholder="Description"
                />
                <div class="flex gap-2 justify-end">
                  <button 
                    (click)="cancelEditingAudience()"
                    class="px-3 py-1 text-xs text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                    Cancel
                  </button>
                  <button 
                    (click)="saveEditedAudience(audience.id)"
                    class="px-3 py-1 text-xs text-white bg-purple-500 hover:bg-purple-600 rounded-lg transition-colors">
                    Save
                  </button>
                </div>
              </div>
            </div>
          </div>
          <p *ngIf="audiences.length >= 8" class="text-sm text-purple-600 dark:text-purple-400 mt-2">
            Maximum 8 audiences reached. Delete one to add more.
          </p>
        </div>

        <!-- FIX #8: Saved Templates Section - 2 Column Layout -->
        <div class="mb-8">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2">
              <div class="w-3 h-3 bg-green-500 rounded-full"></div>
              My Quick Templates
            </h3>
            <button
              *ngIf="templates.length < 8"
              (click)="toggleAddTemplate()"
              class="flex items-center gap-2 px-3 py-2 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
              <lucide-icon [img]="Plus" class="w-4 h-4"></lucide-icon>
              Add Template
            </button>
          </div>

          <!-- Add Template Form -->
          <div *ngIf="showAddTemplate" class="mb-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name *</label>
              <input
                type="text"
                [(ngModel)]="newTemplateName"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white"
                placeholder="e.g., Project Status Update"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Prompt *</label>
              <textarea
                [(ngModel)]="newTemplatePrompt"
                rows="3"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white text-sm resize-none"
                placeholder="e.g., Write a project status update email"
              ></textarea>
            </div>
            <div class="flex gap-2 justify-end">
              <button 
                (click)="cancelAddTemplate()"
                class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                Cancel
              </button>
              <button 
                (click)="saveNewTemplate()"
                [disabled]="!canSaveNewTemplate()"
                class="px-4 py-2 text-sm text-white bg-green-500 hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-lg transition-colors flex items-center gap-2">
                <lucide-icon [img]="Save" class="w-4 h-4"></lucide-icon>
                Save Template
              </button>
            </div>
          </div>

          <!-- FIX #8: 2-Column Grid for Templates -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div *ngFor="let template of templates" 
                 class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
              
              <!-- View Mode -->
              <div *ngIf="editingTemplateId !== template.id" class="flex items-center justify-between w-full">
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <p class="font-medium text-gray-800 dark:text-white">{{ template.name }}</p>
                    <span *ngIf="template.isCustom" 
                          class="px-2 py-1 text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded">
                      Custom
                    </span>
                  </div>
                  <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">{{ template.prompt }}</p>
                </div>
                <div class="flex gap-2 ml-4">
                  <button 
                    (click)="startEditingTemplate(template)"
                    class="p-2 text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-colors"
                    title="Edit">
                    <lucide-icon [img]="Edit3" class="w-4 h-4"></lucide-icon>
                  </button>
                  <button 
                    (click)="deleteTemplateFromSettings(template.id)"
                    class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                    title="Delete">
                    <lucide-icon [img]="Trash2" class="w-4 h-4"></lucide-icon>
                  </button>
                </div>
              </div>

              <!-- Edit Mode -->
              <div *ngIf="editingTemplateId === template.id" class="w-full space-y-2">
                <input
                  type="text"
                  [(ngModel)]="editingTemplateName"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white text-sm"
                  placeholder="Template name"
                />
                <textarea
                  [(ngModel)]="editingTemplatePrompt"
                  rows="3"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white text-sm resize-none"
                  placeholder="Template prompt"
                ></textarea>
                <div class="flex gap-2 justify-end">
                  <button 
                    (click)="cancelEditingTemplate()"
                    class="px-3 py-1 text-xs text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                    Cancel
                  </button>
                  <button 
                    (click)="saveEditedTemplate(template.id)"
                    class="px-3 py-1 text-xs text-white bg-green-500 hover:bg-green-600 rounded-lg transition-colors">
                    Save
                  </button>
                </div>
              </div>
            </div>
          </div>
          <p *ngIf="templates.length >= 8" class="text-sm text-green-600 dark:text-green-400 mt-2">
            Maximum 8 templates reached. Delete one to add more.
          </p>
        </div>

        <!-- Saved Emails Section -->
        <div class="mb-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2">
              <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
              Email Templates Library
            </h3>
            <button
              (click)="toggleManualEmailAdd()"
              class="flex items-center gap-2 px-3 py-2 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
              <lucide-icon [img]="Plus" class="w-4 h-4"></lucide-icon>
              Add Email
            </button>
          </div>

          <!-- Manual Email Add Form -->
          <div *ngIf="showManualEmailAdd" class="mb-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject</label>
              <input
                type="text"
                [(ngModel)]="manualEmailSubject"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white"
                placeholder="Email subject"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Content</label>
              <textarea
                [(ngModel)]="manualEmailContent"
                rows="8"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white font-mono text-sm resize-none"
                placeholder="Email content"
              ></textarea>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tone</label>
                <input
                  type="text"
                  [(ngModel)]="manualEmailTone"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white"
                  placeholder="e.g., Professional"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Audience</label>
                <input
                  type="text"
                  [(ngModel)]="manualEmailAudience"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white"
                  placeholder="e.g., Professor"
                />
              </div>
            </div>

            <div class="flex gap-2 justify-end">
              <button 
                (click)="cancelManualEmailAdd()"
                class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                Cancel
              </button>
              <button 
                (click)="saveManualEmail()"
                [disabled]="!canSaveManualEmail()"
                class="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-lg transition-colors flex items-center gap-2">
                <lucide-icon [img]="Save" class="w-4 h-4"></lucide-icon>
                Save Email
              </button>
            </div>
          </div>

          <div *ngIf="(preferencesService.savedEmails$ | async)?.length === 0" 
               class="text-center py-8 text-gray-500 dark:text-gray-400">
            <lucide-icon [img]="Mail" class="w-12 h-12 mx-auto mb-2 opacity-50"></lucide-icon>
            <p>No saved emails yet</p>
            <p class="text-sm mt-1">Click "Save" on generated emails or "Add Email" to create one manually</p>
          </div>
          <div class="space-y-3">
            <div *ngFor="let email of (preferencesService.savedEmails$ | async)" 
                 class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
              
              <!-- View Mode -->
              <div *ngIf="editingEmailId !== email.id">
                <div class="flex items-start justify-between mb-2">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <p class="font-medium text-gray-800 dark:text-white">{{ email.subject }}</p>
                      <button 
                        (click)="toggleFavorite(email.id)"
                        class="p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded transition-colors">
                        <lucide-icon 
                          [img]="Star" 
                          [class]="email.isFavorite ? 'text-yellow-500 fill-yellow-500' : 'text-gray-400'"
                          class="w-4 h-4"></lucide-icon>
                      </button>
                    </div>
                    <div class="flex gap-2 mb-2">
                      <span class="px-2 py-1 text-xs bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded">
                        {{ email.tone }}
                      </span>
                      <span class="px-2 py-1 text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded">
                        {{ email.audience }}
                      </span>
                      <span class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded">
                        {{ email.timestamp | date:'short' }}
                      </span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">{{ email.content }}</p>
                  </div>
                  <div class="flex gap-2 ml-4">
                    <button 
                      (click)="startEditingEmail(email)"
                      class="p-2 text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-colors"
                      title="Edit">
                      <lucide-icon [img]="Edit3" class="w-4 h-4"></lucide-icon>
                    </button>
                    <button 
                      (click)="copyToClipboard(email.content)"
                      class="p-2 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors"
                      title="Copy">
                      <lucide-icon [img]="Copy" class="w-4 h-4"></lucide-icon>
                    </button>
                    <button 
                      (click)="deleteEmailFromLibrary(email.id)"
                      class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                      title="Delete">
                      <lucide-icon [img]="Trash2" class="w-4 h-4"></lucide-icon>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Edit Mode -->
              <div *ngIf="editingEmailId === email.id" class="space-y-3">
                <!-- Subject Input -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject</label>
                  <input
                    type="text"
                    [(ngModel)]="editingEmailSubject"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white"
                    placeholder="Email subject"
                  />
                </div>

                <!-- Content Textarea -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Content</label>
                  <textarea
                    [(ngModel)]="editingEmailContent"
                    rows="10"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white font-mono text-sm resize-none"
                    placeholder="Email content"
                  ></textarea>
                </div>

                <!-- Tone and Audience -->
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tone</label>
                    <input
                      type="text"
                      [(ngModel)]="editingEmailTone"
                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white"
                      placeholder="Tone"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Audience</label>
                    <input
                      type="text"
                      [(ngModel)]="editingEmailAudience"
                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white"
                      placeholder="Audience"
                    />
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2 justify-end">
                  <button 
                    (click)="cancelEditingEmail()"
                    class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                    Cancel
                  </button>
                  <button 
                    (click)="saveEditedEmail(email.id)"
                    class="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors flex items-center gap-2">
                    <lucide-icon [img]="Save" class="w-4 h-4"></lucide-icon>
                    Save Changes
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- FIX #8: Saved Signatures Section - 2 Column Layout -->
        <div class="mb-8">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center gap-2">
              <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
              My Email Signatures
            </h3>
            <button
              *ngIf="signatures.length < 8"
              (click)="toggleAddSignature()"
              class="flex items-center gap-2 px-3 py-2 text-sm bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
              <lucide-icon [img]="Plus" class="w-4 h-4"></lucide-icon>
              Add Signature
            </button>
          </div>

          <!-- Add Signature Form -->
          <div *ngIf="showAddSignature" class="mb-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name *</label>
              <input
                type="text"
                [(ngModel)]="newSignatureName"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white"
                placeholder="e.g., Professional, Casual, Work"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Signature Content *</label>
              <textarea
                [(ngModel)]="newSignatureContent"
                rows="6"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white font-mono text-sm resize-none"
                placeholder="Best regards,&#10;John Doe&#10;Senior Developer&#10;Company Name&#10;john@example.com&#10;(555) 123-4567"
              ></textarea>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                Tip: Include your name, title, company, email, and phone number
              </p>
            </div>
            <div class="flex gap-2 justify-end">
              <button 
                (click)="cancelAddSignature()"
                class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                Cancel
              </button>
              <button 
                (click)="saveNewSignature()"
                [disabled]="!canSaveNewSignature()"
                class="px-4 py-2 text-sm text-white bg-yellow-500 hover:bg-yellow-600 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-lg transition-colors flex items-center gap-2">
                <lucide-icon [img]="Save" class="w-4 h-4"></lucide-icon>
                Save Signature
              </button>
            </div>
          </div>

          <!-- Empty State -->
          <div *ngIf="signatures.length === 0" 
              class="text-center py-8 text-gray-500 dark:text-gray-400">
            <lucide-icon [img]="FileSignature" class="w-12 h-12 mx-auto mb-2 opacity-50"></lucide-icon>
            <p>No saved signatures yet</p>
            <p class="text-sm mt-1">Click "Add Signature" to create your first email signature</p>
          </div>

          <!-- FIX #8: 2-Column Grid for Signatures -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div *ngFor="let signature of signatures" 
                class="flex items-start justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
              
              <!-- View Mode -->
              <div *ngIf="editingSignatureId !== signature.id" class="flex flex-col w-full">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2">
                    <p class="font-medium text-gray-800 dark:text-white">{{ signature.name }}</p>
                    <span *ngIf="signature.isDefault" 
                          class="px-2 py-1 text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded">
                      Default
                    </span>
                  </div>
                  <div class="flex gap-2">
                    <button 
                      *ngIf="!signature.isDefault"
                      (click)="setAsDefaultSignature(signature.id)"
                      class="p-2 text-yellow-600 dark:text-yellow-400 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 rounded-lg transition-colors"
                      title="Set as default">
                      <lucide-icon [img]="Star" class="w-4 h-4"></lucide-icon>
                    </button>
                    <button 
                      (click)="startEditingSignature(signature)"
                      class="p-2 text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-colors"
                      title="Edit">
                      <lucide-icon [img]="Edit3" class="w-4 h-4"></lucide-icon>
                    </button>
                    <button 
                      *ngIf="signatures.length > 1"
                      (click)="deleteSignatureFromSettings(signature.id)"
                      class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                      title="Delete">
                      <lucide-icon [img]="Trash2" class="w-4 h-4"></lucide-icon>
                    </button>
                  </div>
                </div>
                <pre class="text-sm text-gray-600 dark:text-gray-400 font-mono whitespace-pre-wrap">{{ signature.content }}</pre>
              </div>

              <!-- Edit Mode -->
              <div *ngIf="editingSignatureId === signature.id" class="w-full space-y-2">
                <input
                  type="text"
                  [(ngModel)]="editingSignatureName"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white text-sm"
                  placeholder="Signature name"
                />
                <textarea
                  [(ngModel)]="editingSignatureContent"
                  rows="6"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 bg-white dark:bg-gray-600 text-gray-900 dark:text-white font-mono text-sm resize-none"
                  placeholder="Signature content"
                ></textarea>
                <div class="flex gap-2 justify-end">
                  <button 
                    (click)="cancelEditingSignature()"
                    class="px-3 py-1 text-xs text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-lg transition-colors">
                    Cancel
                  </button>
                  <button 
                    (click)="saveEditedSignature(signature.id)"
                    class="px-3 py-1 text-xs text-white bg-yellow-500 hover:bg-yellow-600 rounded-lg transition-colors">
                    Save
                  </button>
                </div>
              </div>
            </div>
          </div>
          <p *ngIf="signatures.length >= 8" class="text-sm text-yellow-600 dark:text-yellow-400 mt-2">
            Maximum 8 signatures reached. Delete one to add more.
          </p>
        </div>

      </div>

      <!-- Modal Footer -->
      <div class="flex items-center justify-between p-6 border-t border-gray-200 dark:border-gray-700">
        <button 
          (click)="resetPreferencesToDefaults()"
          class="px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
          Reset to Defaults
        </button>
        <button 
          (click)="toggleSettingsModal()"
          class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          Done
        </button>
      </div>
    </div>
  </div>
</div>